<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Cuckoo</title>
  <style>
    @font-face { font-family: edmunds; src: url('fonts/edmunds.otf'); }
  </style>
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/styles.css">
  <script type="text/javascript" src="js/clock.js"></script>
</head>
<body>
  <div class="container">
    <div id="default-wrapper" class="wrapper show">
      <h1>Scan your secret</h1>
    </div>

    <div id="scan-successful-wrapper" class="wrapper">
      <h1>Scan successful</h1>
      <div class="success-animation">
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52"><circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" /><path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" /></svg>
      </div>
    </div>

    <div id="scan-failed-wrapper" class="wrapper">
      <h1>Scan failed :( please try again</h1>

      <div class="ui-error">
        <svg  viewBox="0 0 87 87" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
          <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
              <g id="Group-2" transform="translate(2.000000, 2.000000)">
                <circle id="Oval-2" stroke="rgba(252, 191, 191, .5)" stroke-width="4" cx="41.5" cy="41.5" r="41.5"></circle>
                <circle  class="ui-error-circle" stroke="#F74444" stroke-width="4" cx="41.5" cy="41.5" r="41.5"></circle>
                  <path class="ui-error-line1" d="M22.244224,22 L60.4279902,60.1837662" id="Line" stroke="#F74444" stroke-width="3" stroke-linecap="square"></path>
                  <path class="ui-error-line2" d="M60.755776,21 L23.244224,59.8443492" id="Line" stroke="#F74444" stroke-width="3" stroke-linecap="square"></path>
              </g>
          </g>
      </svg>
      </div>
    </div>

    <div class="button-row">
      <h4>Press a button to test different GUI states:</h4>
      <button class="button-cta button-test" role="button" onclick="toggleView()">Default</button>
      <button class="button-cta" role="button" onclick="toggleView('success')">Success</button>
      <button class="button-cta button-set-alarm" role="button" onclick="toggleView('fail')">Failure</button>
    </div>
    <div id="root"></div>
  </div>

  <script>
    const socket = new WebSocket('ws://localhost:21489/ws');

    const root = document.getElementById('root');
    let alarmTime = null;

    socket.onopen = () => {
      console.log('[open] Connection established');
      console.log('Sending to server');
    };

    socket.onmessage = (event) => {
      root.innerText = event.data;
    };

    socket.onclose = function (event) {
      if (event.wasClean) {
        console.log(
          `[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`
        );
      } else {
        console.log('[close] Connection died');
      }
    };

    socket.onerror = function (event) {
      console.error(`[error] ${event.toString()}`);
    };

    // hide/display clock/alarm
    function toggleView(showStatus) {
      console.log('clicked toggleView ', showStatus);
      const scanSuccessWrapper = document.getElementById("scan-successful-wrapper");
      const defaultWrapper = document.getElementById("default-wrapper");
      const scanFailedWrapper = document.getElementById("scan-failed-wrapper");
      const checkmark = document.getElementsByClassName("checkmark")[0];
      const uiError = document.getElementsByClassName("ui-error")[0];
      let alarmVisible = scanSuccessWrapper.classList.contains("show");
      let clockVisible = defaultWrapper.classList.contains("show");
      let scanFailedVisible = scanFailedWrapper.classList.contains("show");

      if ( !showStatus ) {
        scanSuccessWrapper.classList.remove("show");
        scanFailedWrapper.classList.remove("show");
        defaultWrapper.classList.add("show");
        checkmark.classList.add("hide");
        uiError.classList.remove("show");
      } else if ( showStatus == "success" ) {
        defaultWrapper.classList.remove("show");
        scanFailedWrapper.classList.remove("show");
        scanSuccessWrapper.classList.add("show");
        checkmark.classList.remove("hide");
        checkmark.classList.add("show");
        uiError.classList.remove("show");
      } else if ( showStatus == "fail" ) {
        defaultWrapper.classList.remove("show");
        scanSuccessWrapper.classList.remove("show");
        scanFailedWrapper.classList.add("show");
        checkmark.classList.add("hide");
        uiError.classList.add("show");
      } else {
        console.log('alarmVisible: ', alarmVisible, 'clockVisible: ', clockVisible, showStatus);
      }
    }

    // sound the alarm!!!
    function soundTheAlarm() {
      // socket.send('Cuckoo! Cuckoo! Cuckoo!', true);
      socket.send('cuckoo');
    }

    // set alarm
    function setAlarm() {
      alarmTime = document.getElementById("alarm").value || null;
      socket.send(alarmTime);
      toggleView(false);
      checkAlarm();

      return alarmTime;
    }

    // check alarm time against current time
    function checkAlarm() {
      const dtNow = new Date();
      let dtAlarm = new Date();

      dtAlarm.setHours(alarmTime.split(":")[0]);
      dtAlarm.setMinutes(alarmTime.split(":")[1]);
      dtAlarm.setSeconds(0);

      if (dtAlarm - dtNow > 0) {
        console.log('Later today, no changes needed!');
      }
      else {
        console.log('Tomorrow, changing date to tomorrow');
        dtAlarm.setDate(dtAlarm.getDate() + 1);
      }

      const diff = dtAlarm - new Date();
      setTimeout(soundTheAlarm, diff);
    }
  </script>
</body>
